- virtual_network.qemu_test.migrate_with_file_transfer:
    type = migrate_with_file_transfer
    create_vm_libvirt = "yes"
    kill_vm_libvirt = "yes"
    start_vm = "yes"
    take_regular_screendumps = no
    storage_type = 'nfs'
    setup_local_nfs = 'yes'
    disk_type = "file"
    disk_source_protocol = "netfs"
    nfs_mount_dir = "/var/lib/libvirt/migrate"
    nfs_mount_options = "soft,timeo=50,retrans=3"
    virsh_migrate_dest_state = running
    virsh_migrate_options = "--live --p2p --verbose"
    virsh_migrate_connect_uri = "qemu:///system"
    migration_setup = "yes"
    ssh_remote_auth = True
    mnt_path_name = ${nfs_mount_dir}
    nfs_server_ip = "${migrate_source_host}"
    migrate_desturi_port = "22"
    migrate_desturi_type = "ssh"
    virsh_migrate_desturi = "qemu+ssh://${migrate_dest_host}/system"
    login_timeout = "360"
    guest_path = "/tmp/file"
    file_size = "500"
    transfer_timeout = "240"
    migrate_vm_back = "no"
    migration_type = "precopy"
    virsh_migrate_extra = ""
    vm_ping_outside = pass
    action_during_mig = [{"func": "utils_test.run_file_transfer", "func_param": {"test": params.get('test'), "params": params.get('params'), "env": params.get('env')}}]
    ovmf:
        kill_vm_libvirt_options = " --nvram"
    Windows:
        guest_path = "C:\\tmpfile"
        # Windows guest would migrate 99%-95%-99% in a cycle, we would use --auto-converge
        # to automatically throttle VM CPU when dirty rate is high, also decrease
        # transfer file size in run_file_transfer function, which would make case be more stable.
        virsh_migrate_options = "--live --p2p --verbose --auto-converge"
        filesize = 2000
        clean_cmd = del
    test_iommu = "yes"
    variants:
        - default:
            # Regular test without IOMMU
            test_iommu = "no"
        - with_iommu:
            only virtio_net
            x86_64, i386:
                only q35
                no WinXP WinVista Win7 Win8 Win8.1 Win2003
                no Win2008 Win2008..r2 Win2012 Win2012..r2
                iface_iommu_driver =  {'name':'vhost','iommu': 'on', 'ats': 'on', 'disable-legacy':'on', 'disable-modern':'off'}
                HostCpuVendor.intel:
                    iommu_dict = {'model': 'intel', 'driver': {'intremap': 'on', 'caching_mode': 'on'}}
                    RHEL.7.9:
                        # For RHEL 7.9 compatibility - disable device IOTLB
                        iommu_dict = {'model': 'intel', 'driver': {'intremap': 'on', 'caching_mode': 'on', 'device-iotlb': 'off'}}
                Linux:
                    enable_guest_iommu = "yes"
            aarch64:
                iommu_dict = {'model': 'smmuv3'}
                iface_iommu_driver = {'name':'vhost','iommu': 'on', 'ats': 'on'}
            s390x:
                iface_iommu_driver = {'name':'vhost','iommu': 'on'}
        - with_virtio_iommu:
            required_qemu = [7.0.0,)
            only virtio_net
            only Linux
            only x86_64, aarch64
            x86_64:
                only q35
            iommu_dict = {'model': 'virtio'}
            iface_iommu_driver = {'name':'vhost','iommu': 'on'}
    variants:
        - default_mem:
        - minimum_mem:
            x86_64, aarch64, s390, s390x:
                mem = 1536
            ppc64, ppc64le:
                mem = 3072
            Windows:
                mem = 4096
