- virtual_network.qemu_test.migrate_with_netperf:
    type = migrate_with_netperf
    create_vm_libvirt = "yes"
    kill_vm_libvirt = "yes"
    start_vm = "yes"
    ovmf:
        kill_vm_libvirt_options = " --nvram"
    storage_type = 'nfs'
    setup_local_nfs = 'yes'
    disk_type = "file"
    disk_source_protocol = "netfs"
    nfs_mount_options = "soft,timeo=50,retrans=3"
    virsh_migrate_options = "--live --p2p --verbose"
    virsh_migrate_connect_uri = "qemu:///system"
    migration_setup = "yes"
    ssh_remote_auth = True
    mnt_path_name = ${nfs_mount_dir}
    nfs_server_ip = "${migrate_source_host}"
    migrate_vm_back = "yes"
    migration_type = "precopy"
    virsh_migrate_extra = ""
    vm_ping_outside = pass
    # Netperf parameters
    netperf_timeout = "100"
    netperf_client = "${main_vm}"
    netperf_server = "${migrate_dest_host}"
    server_ip = "${migrate_dest_host}"
    server_user = "root"
    server_pwd = "${migrate_dest_pwd}"
    test_protocol = "TCP_STREAM"
    extra_cmd_opts = " -- -m 1024"
    netperf_iterations = 10
    action_during_mig = [{"func": "network_base.exec_netperf_test", "func_param": {"params": params.get('params'), "env": params.get('env')}, "iterations": ${netperf_iterations}}]
    os_type = "linux"
    firewall_cmd = "systemctl stop firewalld"
    netperf_ver = "netperf-2.7.1"
    netperf_source = "${netperf_ver}.tar.bz2"
    guest_netperf_path = "/tmp/${netperf_source}"
    netperf_install_cmd = "cd /tmp && tar -xjf ${guest_netperf_path} && cd ${netperf_ver} && ./autogen.sh > /dev/null 2>&1 && CFLAGS=-Wno-implicit-function-declaration ./configure > /dev/null 2>&1 && make && make install"
    restore_firewall_cmd = "systemctl start firewalld"
    install_from_file = "yes"
    remote_server = "yes"
    migrate_desturi_port = "16509"
    cp_client = "scp"
    cp_port = "22"
    netserver_cmd = "netserver"
    Windows:
        os_type = "windows"
        firewall_cmd = "netsh advfirewall set allprofiles state off"
        netperf_bin = "netperf.exe"
        netperf_source = "netperf.exe"
        guest_netperf_path = "C:\\netperf.exe"
        netperf_install_cmd = ""
        cp_client = "rss"
        cp_port = "10023"
        # Additional Windows-specific settings for better connectivity
        firewall_delay = "10"
        netserver_cmd = "netserver -p 12865"
        netperf_opts = "-p 12865"
        # Windows guest would migrate 99%-95%-99% in a cycle, we would use --auto-converge
        # to automatically throttle VM CPU when dirty rate is high.
        # also increase mem and decrease -m size to be more stable
        virsh_migrate_options = "--live --p2p --verbose --auto-converge"
        extra_cmd_opts = " -- -m 256 -D"
    variants:
        - tcp:
            migration_protocol = "tcp"
            migrate_desturi_type = "tcp"
            virsh_migrate_desturi = "qemu+tcp://${migrate_dest_host}/system"
