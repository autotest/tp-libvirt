- memory.devices.nvdimm.memory_allocation_and_numa:
    type = nvdimm_memory_with_memory_allocation_and_numa
    no s390-virtio
    start_vm = no
    mem_model = "nvdimm"
    mem_value = 2097152
    current_mem = 2097152
    numa_mem = 2097152
    mem_dict = "'memory_unit':'KiB','memory':${mem_value},'current_mem':${current_mem},'current_mem_unit':'KiB'"
    nvdimm_path = "/tmp/nvdimm"
    nvdimm_size = 524288
    nvdimm_dict = "{'mem_model':'${mem_model}', 'source': {'path': '${nvdimm_path}'}, 'target': {'size': ${nvdimm_size}, 'size_unit': 'KiB'}}"
    func_supported_since_libvirt_ver = (9, 6, 0)
    variants memory_allocation:
        - no_maxmemory:
            max_dict = ""
            define_with_nvdimm:
                define_error = "cannot use/hotplug a memory device when domain 'maxMemory' is not defined"
            cold_plug_error = "cannot use/hotplug a memory device when domain 'maxMemory' is not defined"
            hot_plug_error = "${cold_plug_error}"
            cold_plug_nvdimm.with_node..no_numa:
                cold_plug_error = "can't add memory backend as guest has no NUMA nodes configured"
            hot_plug_nvdimm.with_node..no_numa:
                hot_plug_error = "can't add memory backend as guest has no NUMA nodes configured"
        - no_slot:
            max_mem = 10485760
            max_dict = '"max_mem_rt": ${max_mem}, "max_mem_rt_unit": "KiB",'
            define_with_nvdimm:
                define_error = "failed to find an empty memory slot"
            cold_plug_error = "no free memory device slot available"
            hot_plug_nvdimm..no_node:
                hot_plug_error = "target NUMA node needs to be specified for memory device"
            hot_plug_nvdimm..with_node:
                hot_plug_error = "count of memory devices requiring memory slots '1' exceeds slots count '0'"
        - with_slot:
            max_mem = 10485760
            max_mem_slots = 16
            max_dict = '"max_mem_rt": ${max_mem}, "max_mem_rt_slots": ${max_mem_slots}, "max_mem_rt_unit": "KiB",'
            cold_plug_nvdimm..no_node:
                cold_plug_error = "target NUMA node needs to be specified for memory device"
            hot_plug_nvdimm..no_node:
                hot_plug_error = "target NUMA node needs to be specified for memory device"
            hot_plug_nvdimm..with_node:
                hot_plug_error = "nvdimm is not enabled: missing 'nvdimm' in '-M'"
    variants numa_setting:
        - no_numa:
            numa_dict = ""
        - with_numa:
            numa_dict = ",'vcpu': 4,'cpu':{'numa_cell': [{'id': '0', 'cpus': '0-3', 'memory': '${numa_mem}'}]}"
    variants:
        - with_node:
            no define_with_nvdimm
            nvdimm_dict = "{'mem_model':'${mem_model}', 'source': {'path': '${nvdimm_path}'}, 'target': {'size': ${nvdimm_size}, 'size_unit': 'KiB','node':0}}"
        - no_node:
            define_with_nvdimm..with_numa.with_slot:
                define_error = "target NUMA node needs to be specified for memory device"
            no_numa.with_slot:
                domain_xpath = [{{'element_attrs':["./cpu/numa/cell[@memory='{}']"]}},{{'element_attrs':["./devices/memory/target/size[@unit='KiB']"],'text':'${nvdimm_size}'}},{{'element_attrs':["./currentMemory[@unit='KiB']"],'text':'{}'}}]
        - exceed_max_memory:
            only define_with_nvdimm..no_numa.with_slot
            nvdimm_size = 3145728
            nvdimm_dict = "{'mem_model':'${mem_model}', 'source': {'path': '${nvdimm_path}'}, 'target': {'size': ${nvdimm_size}, 'size_unit': 'KiB'}}"
            define_error = "Total size of memory devices exceeds the total memory size"
    variants device_operation:
        - define_with_nvdimm:
        - cold_plug_nvdimm:
            plug_option = "--config"
        - hot_plug_nvdimm:
            plug_option = ""
    vm_attrs = {${max_dict}${mem_dict}${numa_dict}}

