- memory.devices.nvdimm.plug_and_unplug:
    type = nvdimm_memory_plug_and_unplug
    no s390-virtio
    start_vm = no
    memory_size = 4194304
    curr_memory_size = 4194304
    cpu_mem_attrs = "'vcpu': 4, 'memory_unit':'KiB','memory':${memory_size},'current_mem':${curr_memory_size},'current_mem_unit':'KiB'"
    numa_attrs = "'cpu': {'numa_cell': [{'id': '0', 'cpus': '0-1', 'memory': '2097152', 'unit': 'KiB'}, {'id': '1', 'cpus': '2-3', 'memory': '2097152', 'unit': 'KiB'}]}"
    max_mem_attrs = "'max_mem_rt': 6291456, 'max_mem_rt_slots': 16, 'max_mem_rt_unit': 'KiB'"
    nvdimm_model = "'mem_model':'nvdimm'"
    nvdimm1_path = "/tmp/nvdimm1"
    nvdimm1_size = 512
    nvdimm1_kb_size = 524288
    nvdimm1_unit = "MiB"
    nvdimm1_source = "'source': {'path': '${nvdimm1_path}'}"
    nvdimm1_target = "'target': {'size': ${nvdimm1_size},'size_unit': '${nvdimm1_unit}','node':1, 'label':{'size_unit':'KiB','size':128}}"
    nvdimm1_target_unplug = "'target': {'size': ${nvdimm1_kb_size},'size_unit': 'KiB','node':1, 'label':{'size_unit':'KiB','size':128}}"
    nvdimm2_path = "/tmp/nvdimm2"
    nvdimm2_size = 524288
    nvdimm2_unit = "KiB"
    nvdimm2_source = "'source': {'path': '${nvdimm2_path}'}"
    nvdimm2_target = "'target': {'size': ${nvdimm2_size},'size_unit': '${nvdimm2_unit}','node':0, 'label':{'size_unit':'KiB','size':128}}"
    nvdimm3_path = "/tmp/nvdimm3"
    nvdimm3_size = 3
    nvdimm3_unit = "GiB"
    nvdimm3_source = "'source': {'path': '${nvdimm3_path}'}"
    nvdimm3_target = "'target': {'size': ${nvdimm3_size},'size_unit': '${nvdimm3_unit}','node':0, 'label':{'size_unit':'KiB','size':128}}"
    nvdimm1_addr = "'address':{'attrs': {'slot': '0'}}"
    nvdimm1_dict = {${nvdimm_model},${nvdimm1_source},${nvdimm1_target},${nvdimm1_addr}}
    vm_attrs = {${cpu_mem_attrs}, ${numa_attrs}, ${max_mem_attrs}}
    nvdimm1_target_xpath = "{'element_attrs':[".//target/size[@unit='KiB']"],'text':'${nvdimm1_kb_size}'}, {'element_attrs':[".//target/node"],'text':'1'}, {'element_attrs':[".//target/label/size[@unit='KiB']"],'text':'128'}"
    nvdimm1_source_xpath = "{'element_attrs':[".//source/path"],'text':'${nvdimm1_path}'}"
    nvdimm1_addr_xpath = "{'element_attrs':[".//address[@type='dimm']", ".//address[@slot='0']"]}"
    nvdimm2_target_xpath = "{'element_attrs':[".//target/size[@unit='KiB']"],'text':'${nvdimm2_size}'}, {'element_attrs':[".//target/node"],'text':'0'}, {'element_attrs':[".//target/label/size[@unit='KiB']"],'text':'128'}"
    nvdimm2_source_xpath = "{'element_attrs':[".//source/path"],'text':'${nvdimm2_path}'}"
    nvdimm2_addr_xpath = "{'element_attrs':[".//address[@type='dimm']", ".//address[@slot='1']"]}"
    audit_cmd = "grep VIRT_RESOURCE /var/log/audit/audit.log | grep 'mem' | tail -n 20"
    audit_check = "old-mem={0} new-mem={1}"
    libvirt_log_check = "device_add"
    variants test_case:
        - negative:
            variants:
                - none_existent:
                    only cold_unplug
                    cold_unplug_nvdimms = [${nvdimm1_dict}]
                    error_msg = "matching memory device was not found"
                - duplicate_nvdimm:
                    error_msg = "is already being used by another memory device"
                    init_nvdimms = [${nvdimm1_dict}]
                    cold_plug_nvdimms = [${nvdimm1_dict}]
                - exceed_max_memory:
                    nvdimm2_addr = "'address':{'attrs': {'slot': '1'}}"
                    nvdimm2_dict = {${nvdimm_model},${nvdimm2_source},${nvdimm2_target},${nvdimm2_addr}}
                    nvdimm3_dict = {${nvdimm_model},${nvdimm3_source},${nvdimm3_target}}
                    init_nvdimms = [${nvdimm1_dict}, ${nvdimm2_dict}]
                    cold_plug:
                        cold_plug_nvdimms = [${nvdimm3_dict}]
                    hot_plug:
                        hot_plug_nvdimms = [${nvdimm3_dict}]
                    error_msg = "would exceed domain's maxMemory config size"
                - normal_nvdimm:
                    only hot_unplug
                    init_nvdimms = [${nvdimm1_dict}]
                    hot_unplug_nvdimms = [{${nvdimm_model},${nvdimm1_source},${nvdimm1_target_unplug}}]
                    error_msg = "nvdimm device hot unplug is not supported yet"
            variants plug_type:
                - hot_plug:
                - cold_plug:
                - hot_unplug:
                    only normal_nvdimm
                - cold_unplug:
                    only none_existent
        - positive:
            variants plug_type:
                - hot_plug:
                    hotplug_nvdimms_size = [${nvdimm2_size}]
                    nvdimm2_addr = "'address':{'attrs': {'slot': '1'}}"
                    nvdimm2_dict = {${nvdimm_model},${nvdimm2_source},${nvdimm2_target},${nvdimm2_addr}}
                    init_nvdimms = [${nvdimm1_dict}]
                    init_nvdimms_size = [${nvdimm1_kb_size}]
                    nvdimm1_alias_xpath = "{'element_attrs':[".//alias[@name='nvdimm0']"]}"
                    nvdimm1_addr_xpath = "{'element_attrs':[".//address[@type='dimm']", ".//address[@slot='0']", ".//address[@base]"]}"
                    nvdimm2_alias_xpath = "{'element_attrs':[".//alias[@name='nvdimm1']"]}"
                    nvdimm2_addr_xpath = "{'element_attrs':[".//address[@type='dimm']", ".//address[@slot='1']", ".//address[@base]"]}"
                    startup_xpath = [[${nvdimm1_target_xpath}, ${nvdimm1_source_xpath}, ${nvdimm1_addr_xpath}, ${nvdimm1_alias_xpath}]]
                    hotplug_xpath = [[${nvdimm1_target_xpath}, ${nvdimm1_source_xpath}, ${nvdimm1_addr_xpath}, ${nvdimm1_alias_xpath}], [${nvdimm2_target_xpath}, ${nvdimm2_source_xpath}, ${nvdimm2_addr_xpath}, ${nvdimm2_alias_xpath}]]
                    hot_plug_nvdimms = [${nvdimm2_dict}]
                    plug_event = "device-added"
                    memory_xpath = [{{'element_attrs':["./memory[@unit='KiB']"],'text':'{0}'}}, {{'element_attrs':["./currentMemory[@unit='KiB']"],'text':'${curr_memory_size}'}}]
                - cold_plug:
                    nvdimm2_addr = "'address':{'attrs': {'slot': '1'}}"
                    nvdimm2_dict = {${nvdimm_model},${nvdimm2_source},${nvdimm2_target},${nvdimm2_addr}}
                    init_nvdimms = [${nvdimm1_dict}]
                    cold_plug_nvdimms = [${nvdimm2_dict}]
                    init_xpath = [[${nvdimm1_target_xpath}, ${nvdimm1_source_xpath}, ${nvdimm1_addr_xpath}]]
                    coldplug_xpath = [[${nvdimm1_target_xpath}, ${nvdimm1_source_xpath}, ${nvdimm1_addr_xpath}], [${nvdimm2_target_xpath}, ${nvdimm2_source_xpath}, ${nvdimm2_addr_xpath}]]
                - cold_unplug:
                    init_nvdimms = [${nvdimm1_dict}]
                    cold_unplug_nvdimms = [${nvdimm1_dict}]

